<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard - {{ user.name if user else current_user.name if current_user else 'User' }}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { 
      --accent:#0d6efd; 
      --muted:#6c757d; 
      --bg:#f6f7fb;
      --success:#198754;
      --warning:#ffc107;
      --info:#0dcaf0;
    }
    
    * { box-sizing: border-box; }
    
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      min-height: 100vh;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(255,255,255,0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    .navbar {
      background: rgba(255,255,255,0.95) !important;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    main { position: relative; z-index: 1; }
    
    .card { 
      border-radius: 16px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      position: relative;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--info));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 16px 48px rgba(0,0,0,0.15);
    }
    
    .card:hover::before {
      transform: scaleX(1);
    }
    
    .display-6 { 
      font-weight:700; 
      font-size:2.2rem;
      background: linear-gradient(135deg, var(--accent), var(--info));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .small-muted { 
      color: var(--muted); 
      font-size:0.9rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    #metrics-row .card { 
      min-height:140px;
      cursor: pointer;
    }
    
    #progress-card { 
      height: 320px;
      background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
    }
    
    .metric-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 12px;
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes countUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .count-animation {
      animation: countUp 0.6s ease-out;
    }
    
    .btn {
      border-radius: 10px;
      font-weight: 500;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
    }
    
    #recent-activity li {
      padding: 12px;
      margin-bottom: 8px;
      background: rgba(108,117,125,0.05);
      border-radius: 8px;
      border-left: 3px solid var(--accent);
      transition: all 0.3s ease;
      animation: slideIn 0.5s ease-out backwards;
    }
    
    #recent-activity li:nth-child(1) { animation-delay: 0.1s; }
    #recent-activity li:nth-child(2) { animation-delay: 0.2s; }
    #recent-activity li:nth-child(3) { animation-delay: 0.3s; }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    #recent-activity li:hover {
      background: rgba(108,117,125,0.1);
      transform: translateX(8px);
    }
    
    .progress-bar-custom {
      height: 8px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--info));
      border-radius: 10px;
      transition: width 1s ease-out;
    }
    
    .streak-badge {
      display: inline-block;
      padding: 4px 12px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .notification-dot {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 12px;
      height: 12px;
      background: #f5576c;
      border-radius: 50%;
      border: 2px solid white;
      animation: ping 1.5s ease-in-out infinite;
    }
    
    @keyframes ping {
      0% {
        box-shadow: 0 0 0 0 rgba(245, 87, 108, 0.7);
      }
      100% {
        box-shadow: 0 0 0 10px rgba(245, 87, 108, 0);
      }
    }
    
    footer {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0,0,0,0.05);
      position: relative;
      z-index: 1;
    }
    
    @media (max-width:575px){ 
      .display-6{ font-size:1.6rem } 
      .metric-icon { width: 40px; height: 40px; font-size: 20px; }
    }
    
    .loading-shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/" style="font-size: 1.3rem; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">MySite</a>
    <div class="d-flex align-items-center ms-auto">
      <div class="me-3 text-muted">Hello, <strong>{{ user.name if user else current_user.name if current_user else 'Learner' }}</strong> <span class="streak-badge">üî• 5 day streak</span></div>
      <button id="logoutBtn" class="btn btn-outline-secondary btn-sm position-relative">
        Logout
        <span class="notification-dot"></span>
      </button>
    </div>
  </div>
</nav>

<main class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1 fw-bold" style="color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">Dashboard</h1>
      <small style="color: rgba(255,255,255,0.9);">Overview of your learning journey</small>
    </div>
    <button class="btn btn-light btn-sm" onclick="refreshData()" id="refreshBtn">
      <span id="refreshIcon">üîÑ</span> Refresh
    </button>
  </div>

  <div class="row g-3 mb-3" id="metrics-row">
    <div class="col-md-4">
      <div class="card p-4" onclick="animateCard(this)">
        <div class="metric-icon" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">üìö</div>
        <div class="small-muted">Courses completed</div>
        <div id="m-courses" class="display-6 count-animation">‚Äî</div>
        <div class="progress-bar-custom">
          <div class="progress-fill" id="courses-progress" style="width: 0%"></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-4" onclick="animateCard(this)">
        <div class="metric-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white;">‚≠ê</div>
        <div class="small-muted">Points</div>
        <div id="m-points" class="display-6 count-animation">‚Äî</div>
        <div class="progress-bar-custom">
          <div class="progress-fill" id="points-progress" style="width: 0%"></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-4" onclick="animateCard(this)">
        <div class="metric-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white;">üîî</div>
        <div class="small-muted">Notifications</div>
        <div id="m-notifs" class="display-6 count-animation">‚Äî</div>
        <div class="progress-bar-custom">
          <div class="progress-fill" id="notifs-progress" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="progress-card" class="card p-4 mb-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0 fw-bold">Progress over time</h5>
      <div class="small-muted">Last 7 checkpoints</div>
    </div>
    <div style="height:220px">
      <canvas id="progress-chart" style="max-height:100%"></canvas>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card p-4">
        <h6 class="mb-3 fw-bold">Quick actions</h6>
        <div class="d-flex gap-2 flex-wrap">
          <a class="btn btn-primary" href="/courses">üìñ Continue course</a>
          <a class="btn btn-outline-secondary" href="/profile">üë§ Edit profile</a>
          <a class="btn btn-outline-info" href="/quiz">‚ùì Take a quiz</a>
          <a class="btn btn-outline-success" href="/stock_market">üìà Market demo</a>
          <a class="btn btn-warning" href="/certificate">üèÜ View Certificate</a>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card p-4">
        <h6 class="mb-3 fw-bold">Recent activity</h6>
        <ul id="recent-activity" class="mb-0 list-unstyled small" style="color: #495057;">
          <li>Loading recent activity‚Ä¶</li>
        </ul>
      </div>
    </div>
  </div>
</main>

<footer class="text-center py-4 small text-muted mt-5">
  ¬© {{ (user.name if user else current_user.name if current_user else 'Learner') }} ‚Äî MySite
</footer>

<script>
(function () {
  const el = id => document.getElementById(id);
  const demo = {
    courses_completed: 3,
    points: 1240,
    notifications: 2,
    progress_over_time: [10,25,40,55,70,85,100],
    recent: ['Enrolled: Python Basics', 'Completed: Intro Quiz', 'Earned badge: Beginner']
  };

  let chartInstance = null;

  async function fetchData() {
    try {
      const res = await fetch('/api/dashboard-data', {cache: 'no-store'});
      if (!res.ok) throw new Error('Network');
      const json = await res.json();
      if (json && json.success && json.data) return json.data;
      return demo;
    } catch (e) {
      console.warn('dashboard data fetch failed, using demo', e);
      return demo;
    }
  }

  function animateNumber(element, target) {
    const duration = 1000;
    const start = 0;
    const startTime = performance.now();
    
    function update(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easeProgress = 1 - Math.pow(1 - progress, 3);
      const current = Math.floor(start + (target - start) * easeProgress);
      element.textContent = current;
      
      if (progress < 1) {
        requestAnimationFrame(update);
      } else {
        element.textContent = target;
      }
    }
    
    requestAnimationFrame(update);
  }

  function renderMetrics(data) {
    if (el('m-courses')) {
      animateNumber(el('m-courses'), data.courses_completed ?? 0);
      setTimeout(() => {
        el('courses-progress').style.width = Math.min((data.courses_completed / 10) * 100, 100) + '%';
      }, 200);
    }
    if (el('m-points')) {
      animateNumber(el('m-points'), data.points ?? 0);
      setTimeout(() => {
        el('points-progress').style.width = Math.min((data.points / 2000) * 100, 100) + '%';
      }, 400);
    }
    if (el('m-notifs')) {
      animateNumber(el('m-notifs'), data.notifications ?? 0);
      setTimeout(() => {
        el('notifs-progress').style.width = Math.min((data.notifications / 10) * 100, 100) + '%';
      }, 600);
    }
  }

  function renderRecent(data) {
    const list = el('recent-activity');
    if (!list) return;
    list.innerHTML = '';
    const items = data.recent && data.recent.length ? data.recent : ['No recent activity'];
    items.forEach((it, idx) => {
      const li = document.createElement('li');
      li.className = 'py-1';
      li.style.animationDelay = (idx * 0.1) + 's';
      li.textContent = it;
      list.appendChild(li);
    });
  }

  function renderChart(data) {
    const ctx = el('progress-chart');
    if (!ctx || !window.Chart) return;
    
    if (chartInstance) {
      chartInstance.destroy();
    }
    
    const values = data.progress_over_time || [];
    const labels = values.map((_,i)=>`T${i+1}`);
    
    chartInstance = new Chart(ctx.getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Progress',
          data: values,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 8,
          pointBackgroundColor: '#667eea',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointHoverBackgroundColor: '#764ba2',
          pointHoverBorderColor: '#fff',
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        scales: { 
          y: { 
            beginAtZero: true, 
            max: 100,
            grid: {
              color: 'rgba(0,0,0,0.05)'
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        },
        plugins: { 
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12,
            borderRadius: 8,
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 }
          }
        },
        animation: {
          duration: 2000,
          easing: 'easeInOutQuart'
        }
      }
    });
  }

  async function init() {
    const data = await fetchData();
    renderMetrics(data);
    renderRecent(data);
    renderChart(data);
  }

  window.refreshData = async function() {
    const btn = el('refreshBtn');
    const icon = el('refreshIcon');
    icon.style.display = 'inline-block';
    icon.style.animation = 'spin 1s linear infinite';
    
    const style = document.createElement('style');
    style.textContent = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
    document.head.appendChild(style);
    
    await init();
    
    setTimeout(() => {
      icon.style.animation = '';
      style.remove();
    }, 1000);
  };

  window.animateCard = function(card) {
    card.style.transform = 'scale(0.95)';
    setTimeout(() => {
      card.style.transform = '';
    }, 200);
  };

  const logoutBtn = el('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await fetch('/logout', { method: 'POST' });
      } catch (e) { /* ignore */ }
      window.location = '/';
    });
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>